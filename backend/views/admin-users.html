<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spr√°va u≈æivatel≈Ø - Admin</title>
    <link rel="stylesheet" href="/sass/admin.css">
</head>
<body>
    <div class="admin-header">
        <h1>Spr√°va u≈æivatel≈Ø</h1>
        <div>
            <a href="/admin/dashboard" class="admin-nav-link">Dashboard</a>
            <a href="/admin/orders" class="admin-nav-link">Objedn√°vky</a>
            <a href="/" class="admin-nav-link">‚Üê Zpƒõt na eshop</a>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="admin-section">
            <h2>Seznam u≈æivatel≈Ø</h2>
            
            <!-- Vyhled√°vac√≠ pole -->
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input 
                        type="search" 
                        id="searchInput" 
                        placeholder="Hledat podle jm√©na, emailu nebo telefonu..." 
                        autocomplete="off"
                    >
                    <span class="search-icon">üîç</span>
                </div>
            </div>
            
            <div class="message" id="message"></div>
            <div class="users-list" id="usersList">
                <p>Naƒç√≠t√°m u≈æivatele...</p>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/admin/api';
        
        // Naƒçten√≠ u≈æivatel≈Ø
        async function loadUsers(searchQuery = null) {
            try {
                let url = `${API_BASE}/users`;
                if (searchQuery && searchQuery.trim()) {
                    url += `?search=${encodeURIComponent(searchQuery.trim())}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displayUsers(data.users);
                } else {
                    showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø', 'error');
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø:', error);
                showMessage('Chyba p≈ôipojen√≠ k serveru', 'error');
            }
        }
        
        // Debounce funkce pro vyhled√°v√°n√≠
        let searchTimeout;
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value;
                
                searchTimeout = setTimeout(() => {
                    loadUsers(query);
                }, 300); // ƒåek√° 300ms po posledn√≠m zad√°n√≠ znaku
            });
        }
        
        // Zobrazen√≠ u≈æivatel≈Ø
        function displayUsers(users) {
            const list = document.getElementById('usersList');
            
            if (users.length === 0) {
                list.innerHTML = '<p>≈Ω√°dn√≠ u≈æivatel√©.</p>';
                return;
            }
            
            list.innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <h3>${user.firstName} ${user.lastName}</h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        ${user.phone ? `<p><strong>Telefon:</strong> ${user.phone}</p>` : ''}
                        <p><strong>Registrace:</strong> ${new Date(user.createdAt).toLocaleDateString('cs-CZ')}</p>
                        <p><strong>Ko≈°√≠k:</strong> ${user.cart?.items?.length || 0} polo≈æek</p>
                        <p><strong>Objedn√°vky:</strong> ${user.orders?.length || 0}</p>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="resetPassword('${user.id}')">Resetovat heslo</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.email}')">Smazat</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Reset hesla
        window.resetPassword = async function(userId) {
            const newPassword = prompt('Zadejte nov√© heslo (min. 6 znak≈Ø):');
            
            if (!newPassword || newPassword.length < 6) {
                alert('Heslo mus√≠ m√≠t minim√°lnƒõ 6 znak≈Ø');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Heslo bylo √∫spƒõ≈°nƒõ resetov√°no', 'success');
                } else {
                    showMessage(data.error || 'Chyba p≈ôi resetov√°n√≠ hesla', 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôipojen√≠ k serveru', 'error');
            }
        };
        
        // Smaz√°n√≠ u≈æivatele
        window.deleteUser = async function(userId, userEmail) {
            if (!confirm(`Opravdu chcete smazat u≈æivatele ${userEmail}? Tato akce je nevratn√°.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('U≈æivatel √∫spƒõ≈°nƒõ smaz√°n', 'success');
                    loadUsers();
                } else {
                    showMessage(data.error || 'Chyba p≈ôi maz√°n√≠ u≈æivatele', 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôipojen√≠ k serveru', 'error');
            }
        };
        
        // Zobrazen√≠ zpr√°vy
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }
        
        // Naƒçten√≠ u≈æivatel≈Ø p≈ôi naƒçten√≠ str√°nky
        loadUsers();
    </script>
</body>
</html>

