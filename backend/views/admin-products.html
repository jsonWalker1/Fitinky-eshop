<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spr√°va produkt≈Ø - Admin</title>
    <link rel="stylesheet" href="/sass/admin.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="/assets/pic/logo.png" alt="logo">
            <h2>Eshop Admin</h2>
        </div>
        
        <ul class="sidebar-links">
            <li>
                <a href="/admin/dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span>Dashboard</span>
                </a>
            </li>
            
            <h4 class="sidebar-section-title">Hlavn√≠ menu</h4>
            
            <li>
                <a href="/admin/products" class="active">
                    <span class="material-symbols-outlined">inventory</span>
                    <span>Produkty</span>
                </a>
            </li>
            <li>
                <a href="/admin/categories">
                    <span class="material-symbols-outlined">folder</span>
                    <span>Kategorie</span>
                </a>
            </li>
            <li>
                <a href="/admin/orders">
                    <span class="material-symbols-outlined">shopping_cart</span>
                    <span>Objedn√°vky</span>
                </a>
            </li>
            <li>
                <a href="/admin/users">
                    <span class="material-symbols-outlined">people</span>
                    <span>U≈æivatel√©</span>
                </a>
            </li>
            <li>
                <a href="/admin/messages">
                    <span class="material-symbols-outlined">mail</span>
                    <span>Zpr√°vy</span>
                </a>
            </li>
            
            <h4 class="sidebar-section-title">Dal≈°√≠</h4>
            
            <li>
                <a href="/admin/statistics">
                    <span class="material-symbols-outlined">analytics</span>
                    <span>Statistiky</span>
                </a>
            </li>
            <li>
                <a href="/admin/settings">
                    <span class="material-symbols-outlined">settings</span>
                    <span>Nastaven√≠</span>
                </a>
            </li>
            <li>
                <a href="/" target="_blank">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span>Zobrazit eshop</span>
                </a>
            </li>
            <li>
                <a href="/admin/logout">
                    <span class="material-symbols-outlined">logout</span>
                    <span>Odhl√°sit se</span>
                </a>
            </li>
        </ul>
        
        <div class="sidebar-user">
            <div class="user-profile">
                <img src="/assets/pic/personalicon.bmp" alt="profile">
                <div class="user-info">
                    <h3>Admin</h3>
                    <span>Administr√°tor</span>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Overlay pro mobil -->
    <div class="admin-sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Main Layout -->
    <div class="admin-layout">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <button class="hamburger-menu" id="hamburgerMenu" aria-label="Menu">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <h1>Spr√°va produkt≈Ø</h1>
            </div>
            <div class="header-right">
                <a href="/" class="admin-nav-link">‚Üê Zpƒõt na eshop</a>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-container">
                <div class="products-management">
                    <!-- Header s akcemi -->
                    <div class="products-header">
                        <div class="header-left">
                            <h1>Produkty</h1>
                        </div>
                        <div class="header-right">
                            <button class="btn btn-primary" id="addProductBtn">
                                <span class="material-symbols-outlined">add</span>
                                P≈ôidat produkt
                            </button>
                        </div>
                    </div>
                    
                    <!-- Toolbar s vyhled√°v√°n√≠m a bulk akcemi -->
                    <div class="products-toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <div class="search-input-wrapper">
                                    <input 
                                        type="search" 
                                        id="searchInput" 
                                        placeholder="Hledat produkty..." 
                                        autocomplete="off"
                                    >
                                    <span class="search-icon">üîç</span>
                                </div>
                            </div>
                            
                            <div class="products-filters">
                                <select id="filterCategory" class="filter-select">
                                    <option value="">V≈°echny kategorie</option>
                                </select>
                                
                                <select id="filterStatus" class="filter-select">
                                    <option value="">V≈°echny statusy</option>
                                    <option value="in_stock">Skladem</option>
                                    <option value="on_order">Na objedn√°vku</option>
                                    <option value="out_of_stock">Nedostupn√©</option>
                                </select>
                                
                                <button class="btn btn-secondary" id="clearFiltersBtn" title="Vymazat filtry">
                                    <span class="material-symbols-outlined">filter_alt_off</span>
                                    Vymazat filtry
                                </button>
                            </div>
                            
                            <div class="bulk-actions hidden" id="bulkActions">
                                <span class="bulk-count" id="bulkCount">0 vybr√°no</span>
                                <select id="bulkCategorySelect" class="filter-select">
                                    <option value="">-- Zmƒõnit kategorii --</option>
                                </select>
                                <button class="btn btn-primary" id="bulkChangeCategoryBtn" title="Zmƒõnit kategorii vybran√Ωch produkt≈Ø">
                                    <span class="material-symbols-outlined">folder</span>
                                    Zmƒõnit kategorii
                                </button>
                                <button class="btn btn-danger" id="bulkDeleteBtn">
                                    <span class="material-symbols-outlined">delete</span>
                                    Smazat
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seznam produkt≈Ø -->
                    <div class="products-grid" id="productsGrid">
                        <div class="products-loading">Naƒç√≠t√°m produkty...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal pro p≈ôid√°n√≠/editaci produktu -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">P≈ôidat produkt</h2>
                <button class="modal-close" id="modalClose">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" name="productId">
                    
                    <div class="form-group">
                        <label for="productName">N√°zev produktu *</label>
                        <input type="text" id="productName" name="name" maxlength="255" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productCategory">Kategorie *</label>
                        <select id="productCategory" name="category" required></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="productPrice">Cena (Kƒç) *</label>
                        <input type="number" id="productPrice" name="price" step="0.01" min="0" inputmode="decimal" pattern="[0-9]+([.,][0-9]{1,2})?" onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 44 || event.charCode === 46" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Galerie obr√°zk≈Ø produktu</label>
                        <div class="product-gallery-section">
                            <div class="gallery-upload-options">
                                <label class="upload-option">
                                    <input type="radio" name="imageSource" value="url" checked onchange="toggleImageSource()">
                                    <span>URL obr√°zku</span>
                                </label>
                                <label class="upload-option">
                                    <input type="radio" name="imageSource" value="file" onchange="toggleImageSource()">
                                    <span>Nahr√°t z poƒç√≠taƒçe</span>
                                </label>
                            </div>
                            
                            <div id="imageUrlInput" class="image-input-wrapper">
                                <input type="url" id="productImageUrl" placeholder="https://example.com/image.jpg">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="addImageFromUrl()">P≈ôidat do galerie</button>
                            </div>
                            
                            <div id="imageFileInput" class="image-input-wrapper" style="display: none;">
                                <input type="file" id="productImageFile" name="imageFile" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" multiple onchange="handleImageFileSelect(event)">
                                <div class="upload-progress" id="uploadProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill"></div>
                                    </div>
                                    <span class="progress-text" id="progressText">Nahr√°v√°n√≠...</span>
                                </div>
                            </div>
                            
                            <div class="product-gallery-preview" id="productGalleryPreview">
                                <div class="gallery-empty" id="galleryEmpty">
                                    <span class="material-symbols-outlined">image</span>
                                    <p>≈Ω√°dn√© obr√°zky v galerii</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="productDescription">Popis</label>
                        <textarea id="productDescription" name="description" rows="4" maxlength="2000"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="productStatus">Status dostupnosti *</label>
                        <select id="productStatus" name="availabilityStatus" required>
                            <option value="in_stock">Skladem</option>
                            <option value="on_order">Na objedn√°vku</option>
                            <option value="out_of_stock">Nedostupn√©</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="section-label">Kategorie sortimentu</label>
                        <div class="sortiment-categories">
                            <label class="checkbox-label">
                                <input type="checkbox" id="sortimentBestsellers" name="sortimentCategories" value="nejprodavanejsi">
                                <span>Nejprod√°vanƒõj≈°√≠</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="sortimentInStock" name="sortimentCategories" value="skladem">
                                <span>Skladem</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="sortimentDiscounted" name="sortimentCategories" value="zlevnene">
                                <span>Zlevnƒõn√©</span>
                            </label>
                        </div>
                        <p class="form-hint">Produkt m≈Ø≈æe b√Ωt v nƒõkolika kategori√≠ch sortimentu souƒçasnƒõ</p>
                    </div>
                    
                    <!-- Produktov√© atributy -->
                    <div class="form-group">
                        <label class="section-label">Technick√© atributy</label>
                        <div class="attributes-section">
                            <div class="form-group-inline">
                                <label for="attributeDiameter">Pr≈Ømƒõr (DN)</label>
                                <input type="text" id="attributeDiameter" name="attributeDiameter" placeholder="nap≈ô. 20" maxlength="10" pattern="[0-9]+" onkeypress="return event.charCode >= 48 && event.charCode <= 57" data-diameter-input="true">
                            </div>
                            
                            <div class="form-group-inline">
                                <label for="attributeConnectionType">Typ p≈ôipojen√≠</label>
                                <select id="attributeConnectionType" name="attributeConnectionType">
                                    <option value="">Vyberte typ</option>
                                </select>
                            </div>
                            
                            <div class="form-group-inline">
                                <label for="attributeShape">Tvar</label>
                                <select id="attributeShape" name="attributeShape">
                                    <option value="">Vyberte tvar</option>
                                </select>
                            </div>
                            
                            <div class="form-group-inline">
                                <label for="attributeMaterial">Materi√°l</label>
                                <select id="attributeMaterial" name="attributeMaterial">
                                    <option value="">Vyberte materi√°l</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="modalCancel">Zru≈°it</button>
                        <button type="submit" class="btn btn-primary">Ulo≈æit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/admin/api';
        let selectedProducts = new Set();
        let categories = [];
        let allProducts = [];
        
        // Hamburger menu
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        if (hamburgerMenu) hamburgerMenu.addEventListener('click', toggleSidebar);
        if (overlay) overlay.addEventListener('click', toggleSidebar);
        
        // Atributy hodnoty
        let attributeValues = {
            material: [],
            connection_type: [],
            shape: []
        };
        
        // Naƒçten√≠ kategori√≠
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                if (data.success) {
                    categories = data.categories;
                    populateCategorySelects();
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ kategori√≠:', error);
            }
        }
        
        // Naƒç√≠st hodnoty atribut≈Ø p≈ôi naƒçten√≠ str√°nky
        loadAttributeValues();
        
        // Naƒçten√≠ hodnot atribut≈Ø
        async function loadAttributeValues() {
            try {
                const response = await fetch(`${API_BASE}/attributes/categories`);
                const data = await response.json();
                
                if (data.success && data.categories) {
                    // Konvertovat na objekt podle n√°zvu kategorie
                    data.categories.forEach(category => {
                        if (attributeValues.hasOwnProperty(category.name)) {
                            attributeValues[category.name] = category.values || [];
                        }
                    });
                    
                    // Naplnit selecty
                    populateAttributeSelects();
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ hodnot atribut≈Ø:', error);
            }
        }
        
        // Naplnit selecty s hodnotami atribut≈Ø
        function populateAttributeSelects() {
            // Materi√°l
            const materialSelect = document.getElementById('attributeMaterial');
            if (materialSelect && attributeValues.material && attributeValues.material.length > 0) {
                materialSelect.innerHTML = '<option value="">Vyberte materi√°l</option>' +
                    attributeValues.material.map(v => 
                        `<option value="${escapeHtml(v.value)}">${escapeHtml(v.display_name)}</option>`
                    ).join('');
            }
            
            // Typ p≈ôipojen√≠
            const connectionTypeSelect = document.getElementById('attributeConnectionType');
            if (connectionTypeSelect && attributeValues.connection_type && attributeValues.connection_type.length > 0) {
                connectionTypeSelect.innerHTML = '<option value="">Vyberte typ</option>' +
                    attributeValues.connection_type.map(v => 
                        `<option value="${escapeHtml(v.value)}">${escapeHtml(v.display_name)}</option>`
                    ).join('');
            }
            
            // Tvar
            const shapeSelect = document.getElementById('attributeShape');
            if (shapeSelect && attributeValues.shape && attributeValues.shape.length > 0) {
                shapeSelect.innerHTML = '<option value="">Vyberte tvar</option>' +
                    attributeValues.shape.map(v => 
                        `<option value="${escapeHtml(v.value)}">${escapeHtml(v.display_name)}</option>`
                    ).join('');
            }
        }
        
        function populateCategorySelects() {
            const selects = document.querySelectorAll('#productCategory, #filterCategory, #bulkCategorySelect');
            selects.forEach(select => {
                const isFilter = select.id === 'filterCategory';
                select.innerHTML = isFilter 
                    ? '<option value="">V≈°echny kategorie</option>'
                    : '<option value="">Vyberte kategorii</option>';
                
                // Rozdƒõlit kategorie na hlavn√≠ a podkategorie
                const mainCategories = categories.filter(c => !c.parent_id);
                const subcategories = categories.filter(c => c.parent_id);
                
                // Vytvo≈ôit mapu podkategori√≠ podle parent_id
                const subcategoriesMap = {};
                subcategories.forEach(sub => {
                    if (!subcategoriesMap[sub.parent_id]) {
                        subcategoriesMap[sub.parent_id] = [];
                    }
                    subcategoriesMap[sub.parent_id].push(sub);
                });
                
                // Zobrazit hlavn√≠ kategorie a jejich podkategorie
                mainCategories.forEach(category => {
                    // Hlavn√≠ kategorie
                    const mainOption = document.createElement('option');
                    mainOption.value = category.id;
                    mainOption.textContent = category.name;
                    mainOption.style.fontWeight = '600'; // Tuƒçnƒõ pro hlavn√≠ kategorie
                    select.appendChild(mainOption);
                    
                    // Podkategorie t√©to hlavn√≠ kategorie
                    if (subcategoriesMap[category.id]) {
                        subcategoriesMap[category.id].forEach(subcategory => {
                            const subOption = document.createElement('option');
                            subOption.value = subcategory.id;
                            // Lep≈°√≠ zobrazen√≠ s odsazen√≠m a ≈°ipkou
                            subOption.textContent = `    ‚îú‚îÄ ${subcategory.name}`;
                            subOption.style.paddingLeft = '1rem';
                            select.appendChild(subOption);
                        });
                    }
                });
                
                // Zobrazit podkategorie, kter√© nemaj√≠ hlavn√≠ kategorii (orphaned)
                subcategories.forEach(sub => {
                    if (!mainCategories.find(main => main.id === sub.parent_id)) {
                        const orphanOption = document.createElement('option');
                        orphanOption.value = sub.id;
                        orphanOption.textContent = `    ‚îú‚îÄ ${sub.name}`;
                        orphanOption.style.paddingLeft = '1rem';
                        select.appendChild(orphanOption);
                    }
                });
            });
        }
        
        // Naƒçten√≠ produkt≈Ø s filtry
        async function loadProducts() {
            try {
                const searchQuery = document.getElementById('searchInput')?.value || '';
                const categoryId = document.getElementById('filterCategory')?.value || '';
                const status = document.getElementById('filterStatus')?.value || '';
                
                let url = `${API_BASE}/products?`;
                const params = [];
                
                if (searchQuery.trim()) {
                    params.push(`search=${encodeURIComponent(searchQuery.trim())}`);
                }
                if (categoryId) {
                    params.push(`categoryId=${encodeURIComponent(categoryId)}`);
                }
                if (status) {
                    params.push(`availabilityStatus=${encodeURIComponent(status)}`);
                }
                
                url += params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    allProducts = data.products;
                    displayProducts(allProducts);
                } else {
                    showError('Chyba p≈ôi naƒç√≠t√°n√≠ produkt≈Ø');
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ produkt≈Ø:', error);
                showError('Chyba p≈ôipojen√≠ k serveru');
            }
        }
        
        // Zobrazen√≠ produkt≈Ø (mus√≠ m√≠t p≈ô√≠stup k attributeValues)
        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="products-empty">
                        <div class="empty-icon">
                            <span class="material-symbols-outlined">inventory_2</span>
                        </div>
                        <div class="empty-text">≈Ω√°dn√© produkty</div>
                        <button class="btn btn-primary empty-action" id="addFirstProductBtn">
                            P≈ôidat prvn√≠ produkt
                        </button>
                    </div>
                `;
                document.getElementById('addFirstProductBtn')?.addEventListener('click', openAddModal);
                return;
            }
            
            const statusLabels = {
                'in_stock': 'Skladem',
                'on_order': 'Na objedn√°vku',
                'out_of_stock': 'Nedostupn√©'
            };
            
            grid.innerHTML = products.map(product => {
                const status = product.availabilityStatus || 'in_stock';
                const category = categories.find(c => c.id === product.categoryId || c.slug === product.categorySlug);
                const categoryName = category?.name || product.categoryName || 'Bez kategorie';
                
                return `
                    <div class="product-card" data-product-id="${product.id}">
                        <div class="product-card-header">
                            <input 
                                type="checkbox" 
                                class="product-checkbox" 
                                data-product-id="${product.id}"
                                onchange="toggleProductSelection('${product.id}')"
                            >
                            ${product.image 
                                ? `<img src="${product.image}" alt="${product.name}" class="product-image">`
                                : `<div class="product-image no-image"><span class="material-symbols-outlined">image</span></div>`
                            }
                            <span class="product-status-badge status-${status}">${statusLabels[status]}</span>
                        </div>
                        
                        <div class="product-card-body">
                            <h3 class="product-title">${escapeHtml(product.name)}</h3>
                            <div class="product-category">
                                <span class="category-name" onclick="filterByCategory('${category?.id || ''}')">
                                    ${escapeHtml(categoryName)}
                                </span>
                                <span class="material-symbols-outlined category-edit-icon" onclick="editCategory('${product.id}', '${category?.id || ''}')">
                                    edit
                                </span>
                            </div>
                            ${(() => {
                                // Zobrazit v≈°echny kategorie sortimentu (m≈Ø≈æe jich b√Ωt v√≠ce)
                                const sortimentCategories = product.sortimentCategories || [];
                                const sortimentNames = {
                                    'nejprodavanejsi': 'Nejprod√°vanƒõj≈°√≠',
                                    'skladem': 'Skladem',
                                    'zlevnene': 'Zlevnƒõn√©'
                                };
                                
                                if (sortimentCategories.length > 0) {
                                    return `<div class="product-sortiment-category">
                                        ${sortimentCategories.map(slug => 
                                            `<span class="sortiment-badge sortiment-${slug}">${sortimentNames[slug] || slug}</span>`
                                        ).join(' ')}
                                    </div>`;
                                }
                                
                                // Zpƒõtn√° kompatibilita: pokud nen√≠ pole, pou≈æij star√Ω zp≈Øsob
                                const oldSlug = product.category_slug || product.sortimentCategory;
                                if (oldSlug && ['nejprodavanejsi', 'skladem', 'zlevnene'].includes(oldSlug)) {
                                    return `<div class="product-sortiment-category">
                                        <span class="sortiment-badge sortiment-${oldSlug}">${sortimentNames[oldSlug]}</span>
                                    </div>`;
                                }
                                
                                return '';
                            })()}
                            <div class="product-price">${(typeof product.price === 'number' ? product.price : parseFloat(product.price) || 0).toFixed(2)} Kƒç</div>
                        </div>
                        
                        <div class="product-card-footer">
                            <div class="product-actions">
                                <button class="btn-icon" onclick="editProduct('${product.id}')" title="Editovat">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button class="btn-icon" onclick="deleteProduct('${product.id}')" title="Smazat">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                            <button class="expand-toggle" onclick="toggleProductDetails('${product.id}')">
                                <span>Detail</span>
                                <span class="material-symbols-outlined expand-icon">expand_more</span>
                            </button>
                        </div>
                        
                        <div class="product-details" id="product-details-${product.id}">
                            <div class="product-details-content">
                                <div class="details-section">
                                    <h4 class="section-title">Popis</h4>
                                    <div class="product-description">${product.description || '≈Ω√°dn√Ω popis'}</div>
                                </div>
                                
                                <div class="details-section">
                                    <h4 class="section-title">Kategorie sortimentu</h4>
                                    ${(() => {
                                        // category_slug nebo sortimentCategory = sortiment kategorie
                                        const sortimentSlug = product.category_slug || product.sortimentCategory;
                                        if (sortimentSlug && ['nejprodavanejsi', 'skladem', 'zlevnene'].includes(sortimentSlug)) {
                                            const sortimentNames = {
                                                'nejprodavanejsi': 'Nejprod√°vanƒõj≈°√≠',
                                                'skladem': 'Skladem',
                                                'zlevnene': 'Zlevnƒõn√©'
                                            };
                                            return `<div class="sortiment-info">
                                                <span class="sortiment-badge sortiment-${sortimentSlug}">${sortimentNames[sortimentSlug]}</span>
                                            </div>`;
                                        }
                                        return '<div class="sortiment-info"><span class="sortiment-none">≈Ω√°dn√° kategorie sortimentu</span></div>';
                                    })()}
                                </div>
                                
                                <div class="details-section">
                                    <h4 class="section-title">Upravit produkt</h4>
                                    <form class="product-edit-form" id="edit-form-${product.id}" onsubmit="saveProduct(event, '${product.id}')">
                                        <div class="form-group">
                                            <label>N√°zev</label>
                                            <input type="text" name="name" value="${escapeHtml(product.name)}" maxlength="255" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Kategorie</label>
                                            <select name="category" required>
                                                <option value="">Naƒç√≠t√°m kategorie...</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Cena (Kƒç)</label>
                                            <input type="number" name="price" step="0.01" min="0" inputmode="decimal" value="${product.price}" pattern="[0-9]+([.,][0-9]{1,2})?" onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 44 || event.charCode === 46" required>
                                        </div>
                                        <div class="form-group">
                                            <label>URL obr√°zku</label>
                                            <input type="url" name="image" value="${escapeHtml(product.image || '')}" placeholder="https://example.com/image.jpg">
                                        </div>
                                        <div class="form-group">
                                            <label>Popis</label>
                                            <textarea name="description" rows="3" maxlength="2000">${escapeHtml(product.description || '')}</textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Status</label>
                                            <select name="availabilityStatus" required>
                                                <option value="in_stock" ${status === 'in_stock' ? 'selected' : ''}>Skladem</option>
                                                <option value="on_order" ${status === 'on_order' ? 'selected' : ''}>Na objedn√°vku</option>
                                                <option value="out_of_stock" ${status === 'out_of_stock' ? 'selected' : ''}>Nedostupn√©</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="section-label">Kategorie sortimentu</label>
                                            <div class="sortiment-categories">
                                                <label class="checkbox-label">
                                                    <input type="checkbox" name="sortimentCategories" value="nejprodavanejsi"                                                     ${(() => {
                                                        const sortimentSlug = product.category_slug || product.sortimentCategory;
                                                        return sortimentSlug === 'nejprodavanejsi' ? 'checked' : '';
                                                    })()}>
                                                    <span>Nejprod√°vanƒõj≈°√≠</span>
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" name="sortimentCategories" value="skladem"                                                     ${(() => {
                                                        const sortimentSlug = product.category_slug || product.sortimentCategory;
                                                        return sortimentSlug === 'skladem' ? 'checked' : '';
                                                    })()}>
                                                    <span>Skladem</span>
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" name="sortimentCategories" value="zlevnene"                                                     ${(() => {
                                                        const sortimentSlug = product.category_slug || product.sortimentCategory;
                                                        return sortimentSlug === 'zlevnene' ? 'checked' : '';
                                                    })()}>
                                                    <span>Zlevnƒõn√©</span>
                                                </label>
                                            </div>
                                            <p class="form-hint">Produkt m≈Ø≈æe b√Ωt v nƒõkolika kategori√≠ch sortimentu souƒçasnƒõ</p>
                                        </div>
                                        
                                        <!-- Atributy v inline editaci -->
                                        <div class="form-group">
                                            <label class="section-label">Technick√© atributy</label>
                                            <div class="attributes-section">
                                                <div class="form-group-inline">
                                                    <label>Pr≈Ømƒõr (DN)</label>
                                                    <input type="text" name="attributeDiameter" value="${(() => {
                                                        const diameterValue = product.attributes?.diameter?.value || '';
                                                        // Pokud u≈æ obsahuje 'DN', zobrazit jen ƒç√≠slo, jinak zobrazit celou hodnotu
                                                        if (diameterValue && diameterValue.toUpperCase().startsWith('DN')) {
                                                            return diameterValue.replace(/^DN\s*/i, '');
                                                        }
                                                        return diameterValue;
                                                    })()}" placeholder="nap≈ô. 20" maxlength="10" pattern="[0-9]+" onkeypress="return event.charCode >= 48 && event.charCode <= 57" data-diameter-input="true">
                                                </div>
                                                
                                                <div class="form-group-inline">
                                                    <label>Typ p≈ôipojen√≠</label>
                                                    <select name="attributeConnectionType">
                                                        <option value="">Vyberte typ</option>
                                                        ${(attributeValues.connection_type || []).map(v => 
                                                            `<option value="${escapeHtml(v.value)}" ${(product.attributes?.connection_type?.value === v.value) ? 'selected' : ''}>${escapeHtml(v.display_name)}</option>`
                                                        ).join('')}
                                                    </select>
                                                </div>
                                                
                                                <div class="form-group-inline">
                                                    <label>Tvar</label>
                                                    <select name="attributeShape">
                                                        <option value="">Vyberte tvar</option>
                                                        ${(attributeValues.shape || []).map(v => 
                                                            `<option value="${escapeHtml(v.value)}" ${(product.attributes?.shape?.value === v.value) ? 'selected' : ''}>${escapeHtml(v.display_name)}</option>`
                                                        ).join('')}
                                                    </select>
                                                </div>
                                                
                                                <div class="form-group-inline">
                                                    <label>Materi√°l</label>
                                                    <select name="attributeMaterial">
                                                        <option value="">Vyberte materi√°l</option>
                                                        ${(attributeValues.material || []).map(v => 
                                                            `<option value="${escapeHtml(v.value)}" ${(product.attributes?.material?.value === v.value) ? 'selected' : ''}>${escapeHtml(v.display_name)}</option>`
                                                        ).join('')}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary">Ulo≈æit zmƒõny</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle produkt selection
        window.toggleProductSelection = function(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }
            updateBulkActions();
        };
        
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const bulkCount = document.getElementById('bulkCount');
            const count = selectedProducts.size;
            
            if (count > 0) {
                bulkActions.classList.remove('hidden');
                bulkCount.textContent = `${count} vybr√°no`;
            } else {
                bulkActions.classList.add('hidden');
            }
            
            // Update checkboxy
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                const productId = checkbox.dataset.productId;
                checkbox.checked = selectedProducts.has(productId);
            });
        }
        
        // Bulk change category
        document.getElementById('bulkChangeCategoryBtn')?.addEventListener('click', async () => {
            if (selectedProducts.size === 0) return;
            
            const categorySelect = document.getElementById('bulkCategorySelect');
            const categoryId = categorySelect.value;
            
            if (!categoryId) {
                showError('Vyberte kategorii');
                return;
            }
            
            const category = categories.find(c => c.id === categoryId);
            if (!category) {
                showError('Neplatn√° kategorie');
                return;
            }
            
            if (!confirm(`Opravdu chcete zmƒõnit kategorii u ${selectedProducts.size} produkt≈Ø na "${category.name}"?`)) return;
            
            try {
                const promises = Array.from(selectedProducts).map(id => 
                    fetch(`${API_BASE}/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category: categoryId })
                    })
                );
                
                const results = await Promise.all(promises);
                const allSuccess = results.every(r => r.ok);
                
                const count = selectedProducts.size;
                selectedProducts.clear();
                categorySelect.value = '';
                updateBulkActions();
                loadProducts();
                
                if (allSuccess) {
                    showSuccess(`Kategorie zmƒõnƒõna u ${count} produkt≈Ø`);
                } else {
                    showError('Chyba p≈ôi zmƒõnƒõ kategorie nƒõkter√Ωch produkt≈Ø');
                }
            } catch (error) {
                console.error('Chyba p≈ôi zmƒõnƒõ kategorie:', error);
                showError('Chyba p≈ôipojen√≠ k serveru');
            }
        });
        
        // Bulk delete
        document.getElementById('bulkDeleteBtn')?.addEventListener('click', async () => {
            if (selectedProducts.size === 0) return;
            
            if (!confirm(`Opravdu chcete smazat ${selectedProducts.size} produkt≈Ø?`)) return;
            
            try {
                const promises = Array.from(selectedProducts).map(id => 
                    fetch(`${API_BASE}/products/${id}`, { method: 'DELETE' })
                );
                
                await Promise.all(promises);
                selectedProducts.clear();
                updateBulkActions();
                loadProducts();
                showSuccess('Produkty √∫spƒõ≈°nƒõ smaz√°ny');
            } catch (error) {
                showError('Chyba p≈ôi maz√°n√≠ produkt≈Ø');
            }
        });
        
        // Toggle product details
        window.toggleProductDetails = async function(productId) {
            const details = document.getElementById(`product-details-${productId}`);
            const icon = details.previousElementSibling.querySelector('.expand-icon');
            
            // Pokud se detail otev√≠r√° poprv√©, naƒç√≠st hodnoty atribut≈Ø a kategori√≠ pro selecty v inline editoru
            if (!details.classList.contains('expanded')) {
                // Zkontrolovat, jestli jsou kategorie naƒçten√©
                if (!categories || categories.length === 0) {
                    await loadCategories();
                }
                
                // Zkontrolovat, jestli jsou hodnoty atribut≈Ø naƒçten√©
                if (!attributeValues.material || attributeValues.material.length === 0) {
                    await loadAttributeValues();
                }
                
                // Naplnit selecty v inline editoru pro tento produkt
                const form = details.querySelector(`#edit-form-${productId}`);
                if (form) {
                    populateInlineAttributeSelects(form, productId);
                }
            }
            
            details.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        };
        
        // Naplnit selecty atribut≈Ø v inline editoru
        function populateInlineAttributeSelects(form, productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Typ p≈ôipojen√≠
            const connectionTypeSelect = form.querySelector('select[name="attributeConnectionType"]');
            if (connectionTypeSelect && attributeValues.connection_type && attributeValues.connection_type.length > 0) {
                const currentValue = product.attributes?.connection_type?.value || '';
                connectionTypeSelect.innerHTML = '<option value="">Vyberte typ</option>' +
                    attributeValues.connection_type.map(v => 
                        `<option value="${escapeHtml(v.value)}" ${v.value === currentValue ? 'selected' : ''}>${escapeHtml(v.display_name)}</option>`
                    ).join('');
            }
            
            // Tvar
            const shapeSelect = form.querySelector('select[name="attributeShape"]');
            if (shapeSelect && attributeValues.shape && attributeValues.shape.length > 0) {
                const currentValue = product.attributes?.shape?.value || '';
                shapeSelect.innerHTML = '<option value="">Vyberte tvar</option>' +
                    attributeValues.shape.map(v => 
                        `<option value="${escapeHtml(v.value)}" ${v.value === currentValue ? 'selected' : ''}>${escapeHtml(v.display_name)}</option>`
                    ).join('');
            }
            
            // Materi√°l
            const materialSelect = form.querySelector('select[name="attributeMaterial"]');
            if (materialSelect && attributeValues.material && attributeValues.material.length > 0) {
                const currentValue = product.attributes?.material?.value || '';
                materialSelect.innerHTML = '<option value="">Vyberte materi√°l</option>' +
                    attributeValues.material.map(v => 
                        `<option value="${escapeHtml(v.value)}" ${v.value === currentValue ? 'selected' : ''}>${escapeHtml(v.display_name)}</option>`
                    ).join('');
            }
            
            // Kategorie - naplnit select kategori√≠ s hierarchi√≠
            const categorySelect = form.querySelector('select[name="category"]');
            if (categorySelect && categories && categories.length > 0) {
                const currentCategoryId = product.categoryId || '';
                categorySelect.innerHTML = '';
                
                // Rozdƒõlit kategorie na hlavn√≠ a podkategorie
                const mainCategories = categories.filter(c => !c.parent_id);
                const subcategories = categories.filter(c => c.parent_id);
                
                // Vytvo≈ôit mapu podkategori√≠ podle parent_id a naj√≠t n√°zvy nad≈ôazen√Ωch kategori√≠
                const subcategoriesMap = {};
                subcategories.forEach(sub => {
                    if (!subcategoriesMap[sub.parent_id]) {
                        subcategoriesMap[sub.parent_id] = [];
                    }
                    subcategoriesMap[sub.parent_id].push(sub);
                });
                
                // Zobrazit hlavn√≠ kategorie a jejich podkategorie
                mainCategories.forEach(category => {
                    // Hlavn√≠ kategorie
                    const mainOption = document.createElement('option');
                    mainOption.value = category.id;
                    mainOption.textContent = category.name;
                    mainOption.style.fontWeight = '600';
                    if (category.id === currentCategoryId) {
                        mainOption.selected = true;
                    }
                    categorySelect.appendChild(mainOption);
                    
                    // Podkategorie t√©to hlavn√≠ kategorie
                    if (subcategoriesMap[category.id]) {
                        subcategoriesMap[category.id].forEach(subcategory => {
                            const subOption = document.createElement('option');
                            subOption.value = subcategory.id;
                            // Zobrazit n√°zev hlavn√≠ kategorie > podkategorie pro p≈ôehlednost
                            subOption.textContent = `${category.name} > ${subcategory.name}`;
                            if (subcategory.id === currentCategoryId) {
                                subOption.selected = true;
                            }
                            categorySelect.appendChild(subOption);
                        });
                    }
                });
                
                // Zobrazit podkategorie, kter√© nemaj√≠ hlavn√≠ kategorii (orphaned)
                subcategories.forEach(sub => {
                    if (!mainCategories.find(main => main.id === sub.parent_id)) {
                        const parentCategory = categories.find(c => c.id === sub.parent_id);
                        const orphanOption = document.createElement('option');
                        orphanOption.value = sub.id;
                        orphanOption.textContent = parentCategory 
                            ? `${parentCategory.name} > ${sub.name}`
                            : sub.name;
                        if (sub.id === currentCategoryId) {
                            orphanOption.selected = true;
                        }
                        categorySelect.appendChild(orphanOption);
                    }
                });
            }
        }
        
        // Product gallery management
        let currentProductGallery = [];
        let editingProductId = null;
        
        // Load product images
        async function loadProductImages(productId) {
            try {
                const response = await fetch(`${API_BASE}/products/${productId}/images`);
                const data = await response.json();
                if (data.success) {
                    currentProductGallery = data.images.map(img => ({
                        id: img.id,
                        url: img.url,
                        displayOrder: img.displayOrder
                    }));
                    displayProductGallery();
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ obr√°zk≈Ø:', error);
            }
        }
        
        // Display product gallery
        function displayProductGallery() {
            const galleryContainer = document.getElementById('productGalleryPreview');
            if (!galleryContainer) return;
            
            if (currentProductGallery.length === 0) {
                galleryContainer.innerHTML = `
                    <div class="gallery-empty" id="galleryEmpty">
                        <span class="material-symbols-outlined">image</span>
                        <p>≈Ω√°dn√© obr√°zky v galerii</p>
                    </div>
                `;
                return;
            }
            
            galleryContainer.innerHTML = currentProductGallery.map((img, index) => `
                <div class="gallery-item" data-image-id="${img.id || 'temp-' + index}">
                    <img src="${img.url}" alt="Obr√°zek ${index + 1}">
                    <div class="gallery-item-actions">
                        <button type="button" class="btn-icon" onclick="moveImageUp(${index})" title="Posunout nahoru" ${index === 0 ? 'disabled' : ''}>
                            <span class="material-symbols-outlined">arrow_upward</span>
                        </button>
                        <button type="button" class="btn-icon" onclick="moveImageDown(${index})" title="Posunout dol≈Ø" ${index === currentProductGallery.length - 1 ? 'disabled' : ''}>
                            <span class="material-symbols-outlined">arrow_downward</span>
                        </button>
                        <button type="button" class="btn-icon btn-danger" onclick="removeImageFromGallery(${index})" title="Odstranit">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                    ${index === 0 ? '<div class="gallery-item-primary">Hlavn√≠</div>' : ''}
                </div>
            `).join('');
        }
        
        // Add image from URL
        window.addImageFromUrl = function() {
            const urlInput = document.getElementById('productImageUrl');
            const url = urlInput.value.trim();
            if (!url) {
                showError('Zadejte URL obr√°zku');
                return;
            }
            currentProductGallery.push({
                id: null,
                url: url,
                displayOrder: currentProductGallery.length
            });
            urlInput.value = '';
            displayProductGallery();
        };
        
        // Handle multiple file select
        window.handleImageFileSelect = async function(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            uploadProgress.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    progressText.textContent = `Nahr√°v√°m ${i + 1} / ${files.length}...`;
                    const imageUrl = await uploadImageFile(file);
                    currentProductGallery.push({
                        id: null,
                        url: imageUrl,
                        displayOrder: currentProductGallery.length
                    });
                } catch (error) {
                    console.error('Chyba p≈ôi nahr√°v√°n√≠ obr√°zku:', error);
                    showError(`Chyba p≈ôi nahr√°v√°n√≠ obr√°zku ${file.name}`);
                }
            }
            
            uploadProgress.style.display = 'none';
            event.target.value = '';
            displayProductGallery();
        };
        
        // Move image up
        window.moveImageUp = function(index) {
            if (index <= 0) return;
            [currentProductGallery[index - 1], currentProductGallery[index]] = 
                [currentProductGallery[index], currentProductGallery[index - 1]];
            displayProductGallery();
        };
        
        // Move image down
        window.moveImageDown = function(index) {
            if (index >= currentProductGallery.length - 1) return;
            [currentProductGallery[index], currentProductGallery[index + 1]] = 
                [currentProductGallery[index + 1], currentProductGallery[index]];
            displayProductGallery();
        };
        
        // Remove image from gallery
        window.removeImageFromGallery = function(index) {
            currentProductGallery.splice(index, 1);
            displayProductGallery();
        };
        
        // Edit product
        window.editProduct = async function(productId) {
            editingProductId = productId;
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productStatus').value = product.availabilityStatus || 'in_stock';
            
            const category = categories.find(c => c.id === product.categoryId || c.slug === product.categorySlug);
            if (category) {
                document.getElementById('productCategory').value = category.id;
            }
            
            // Naplnit kategorie sortimentu - m≈Ø≈æe jich b√Ωt v√≠ce
            const sortimentCategories = product.sortimentCategories || [];
            let currentSortiment = [];
            
            if (sortimentCategories.length > 0) {
                // Pou≈æ√≠t pole sortimentCategories
                currentSortiment = sortimentCategories;
            } else if (product.category_slug || product.sortimentCategory) {
                // Zpƒõtn√° kompatibilita: pokud nen√≠ pole, pou≈æij star√Ω zp≈Øsob
                const oldSlug = product.category_slug || product.sortimentCategory;
                if (oldSlug && ['nejprodavanejsi', 'skladem', 'zlevnene'].includes(oldSlug)) {
                    currentSortiment = [oldSlug];
                }
            }
            
            // Resetovat v≈°echny checkboxy
            document.getElementById('sortimentBestsellers').checked = false;
            document.getElementById('sortimentInStock').checked = false;
            document.getElementById('sortimentDiscounted').checked = false;
            
            // Za≈°krtnout v≈°echny za≈°krtnut√© kategorie sortimentu
            if (currentSortiment.includes('nejprodavanejsi')) {
                document.getElementById('sortimentBestsellers').checked = true;
            }
            if (currentSortiment.includes('skladem')) {
                document.getElementById('sortimentInStock').checked = true;
            }
            if (currentSortiment.includes('zlevnene')) {
                document.getElementById('sortimentDiscounted').checked = true;
            }
            
            // Debug log
            console.log('Loading product for edit:', {
                productId: product.id,
                category_slug: product.category_slug,
                categorySlug: product.categorySlug,
                currentSortiment: currentSortiment,
                checkboxes: {
                    bestsellers: document.getElementById('sortimentBestsellers').checked,
                    inStock: document.getElementById('sortimentInStock').checked,
                    discounted: document.getElementById('sortimentDiscounted').checked
                }
            });
            
            // Naƒç√≠st hodnoty atribut≈Ø z API p≈ôed naplnƒõn√≠m formul√°≈ôe
            await loadAttributeValues();
            
            // Naplnit atributy
            if (product.attributes) {
                if (product.attributes.diameter?.value) {
                    // Zobrazit jen ƒç√≠slo (bez "DN"), pokud tam je
                    let diameterValue = product.attributes.diameter.value;
                    if (diameterValue && diameterValue.toUpperCase().startsWith('DN')) {
                        diameterValue = diameterValue.replace(/^DN\s*/i, '');
                    }
                    document.getElementById('attributeDiameter').value = diameterValue;
                }
                if (product.attributes.connection_type?.value) {
                    document.getElementById('attributeConnectionType').value = product.attributes.connection_type.value;
                }
                if (product.attributes.shape?.value) {
                    document.getElementById('attributeShape').value = product.attributes.shape.value;
                }
                if (product.attributes.material?.value) {
                    document.getElementById('attributeMaterial').value = product.attributes.material.value;
                }
            } else {
                // Vyƒçistit pokud nejsou atributy
                document.getElementById('attributeDiameter').value = '';
                document.getElementById('attributeConnectionType').value = '';
                document.getElementById('attributeShape').value = '';
                document.getElementById('attributeMaterial').value = '';
            }
            
            // Load product images from API
            currentProductGallery = [];
            await loadProductImages(productId);
            
            // Nastavit URL jako v√Ωchoz√≠ p≈ôi editaci
            document.querySelector('input[name="imageSource"][value="url"]').checked = true;
            toggleImageSource();
            
            document.getElementById('modalTitle').textContent = 'Upravit produkt';
            document.getElementById('productModal').classList.add('active');
        };
        
        // Edit category
        window.editCategory = function(productId, categoryId) {
            // Implementovat editaci kategorie produktu
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Otev≈ô√≠t modal s mo≈ænost√≠ zmƒõny kategorie
            editProduct(productId);
            document.getElementById('productCategory').focus();
        };
        
        // Filter by category (from product card)
        window.filterByCategory = function(categoryId) {
            if (!categoryId) {
                document.getElementById('filterCategory').value = '';
            } else {
                document.getElementById('filterCategory').value = categoryId;
            }
            loadProducts();
        };
        
        // Delete product
        window.deleteProduct = async function(id) {
            if (!confirm('Opravdu chcete smazat tento produkt?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/products/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Produkt √∫spƒõ≈°nƒõ smaz√°n');
                    loadProducts();
                } else {
                    showError(data.error || 'Chyba p≈ôi maz√°n√≠ produktu');
                }
            } catch (error) {
                showError('Chyba p≈ôipojen√≠ k serveru');
            }
        };
        
        // Save product (from inline form)
        window.saveProduct = async function(event, productId) {
            event.preventDefault();
            
            const form = event.target;
            
            // Z√≠skat v≈°echny za≈°krtnut√© kategorie sortimentu (m≈Ø≈æe jich b√Ωt v√≠ce)
            const sortimentCheckboxes = form.querySelectorAll('input[name="sortimentCategories"]:checked');
            const sortimentCategories = Array.from(sortimentCheckboxes).map(cb => cb.value);
            
            const formData = {
                name: form.name.value,
                category: form.category.value,
                price: parseFloat(form.price.value),
                image: form.image?.value || null, // Voliteln√© pole image
                description: form.description.value,
                availabilityStatus: form.availabilityStatus.value,
                sortimentCategories: sortimentCategories // Pole kategori√≠ sortimentu (m≈Ø≈æe jich b√Ωt v√≠ce)
            };
            
            console.log('Saving product (inline editor) with sortimentCategories:', sortimentCategories);
            
            // Sb√≠rat atributy - pouze pokud maj√≠ hodnotu
            const attributes = {};
            if (form.attributeDiameter?.value) {
                // Automaticky p≈ôidat "DN " p≈ôed ƒç√≠slo, pokud tam je≈°tƒõ nen√≠
                let diameterValue = form.attributeDiameter.value.trim();
                if (diameterValue && !diameterValue.toUpperCase().startsWith('DN')) {
                    diameterValue = 'DN ' + diameterValue;
                }
                attributes.diameter = { value: diameterValue, type: 'text' };
            }
            if (form.attributeConnectionType?.value) {
                attributes.connection_type = { value: form.attributeConnectionType.value, type: 'text' };
            }
            if (form.attributeShape?.value) {
                attributes.shape = { value: form.attributeShape.value, type: 'text' };
            }
            if (form.attributeMaterial?.value) {
                attributes.material = { value: form.attributeMaterial.value, type: 'text' };
            }
            
            // P≈ôidat atributy pouze pokud jsou nƒõjak√© vyplnƒõn√©
            if (Object.keys(attributes).length > 0) {
                formData.attributes = attributes;
            }
            
            try {
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Zkontrolovat hodnoty produktu z SQL
                    console.log('=== PRODUKT √öSPƒö≈†Nƒö ULO≈ΩEN (INLINE EDITOR) ===');
                    console.log('Product ID:', productId);
                    console.log('Form data:', formData);
                    console.log('Response data:', data);
                    
                    // Naƒç√≠st produkt znovu z API pro kontrolu hodnot z SQL
                    const checkResponse = await fetch(`${API_BASE}/products/${productId}`);
                    const checkData = await checkResponse.json();
                    
                    if (checkData.success && checkData.product) {
                        console.log('=== HODNOTY PRODUKTU Z SQL ===');
                        console.log('ID:', checkData.product.id);
                        console.log('N√°zev:', checkData.product.name);
                        console.log('Kategorie ID:', checkData.product.categoryId);
                        console.log('Technick√° kategorie slug:', checkData.product.categorySlug);
                        console.log('Sortiment kategorie (category_slug):', checkData.product.category_slug);
                        console.log('Sortiment kategorie (sortimentCategory):', checkData.product.sortimentCategory);
                        console.log('Sortiment kategorie (sortimentCategories - pole):', checkData.product.sortimentCategories);
                        console.log('Cena:', checkData.product.price);
                        console.log('Status:', checkData.product.availabilityStatus);
                        console.log('================================');
                    } else {
                        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ produktu pro kontrolu:', checkData);
                    }
                    
                    showSuccess('Produkt √∫spƒõ≈°nƒõ aktualizov√°n');
                    loadProducts();
                } else {
                    showError(data.error || 'Chyba p≈ôi aktualizaci produktu');
                }
            } catch (error) {
                showError('Chyba p≈ôipojen√≠ k serveru');
            }
        };
        
        // Image upload functions
        window.toggleImageSource = function() {
            const urlRadio = document.querySelector('input[name="imageSource"][value="url"]');
            const fileRadio = document.querySelector('input[name="imageSource"][value="file"]');
            const urlInput = document.getElementById('imageUrlInput');
            const fileInput = document.getElementById('imageFileInput');
            
            if (urlRadio && urlRadio.checked) {
                if (urlInput) urlInput.style.display = 'block';
                if (fileInput) fileInput.style.display = 'none';
                const fileInputEl = document.getElementById('productImageFile');
                if (fileInputEl) fileInputEl.value = '';
            } else if (fileRadio && fileRadio.checked) {
                if (urlInput) urlInput.style.display = 'none';
                if (fileInput) fileInput.style.display = 'block';
                const urlInputEl = document.getElementById('productImageUrl');
                if (urlInputEl) urlInputEl.value = '';
            }
        };
        
        async function uploadImageFile(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            const progressBar = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const uploadProgress = document.getElementById('uploadProgress');
            
            uploadProgress.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = 'Nahr√°v√°n√≠...';
            
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        progressText.textContent = `Nahr√°v√°n√≠... ${Math.round(percentComplete)}%`;
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                progressText.textContent = 'Nahr√°no √∫spƒõ≈°nƒõ!';
                                setTimeout(() => {
                                    uploadProgress.style.display = 'none';
                                }, 1000);
                                resolve(response.url);
                            } else {
                                uploadProgress.style.display = 'none';
                                reject(new Error(response.error || 'Chyba p≈ôi nahr√°v√°n√≠'));
                            }
                        } catch (e) {
                            uploadProgress.style.display = 'none';
                            reject(new Error('Chyba p≈ôi parsov√°n√≠ odpovƒõdi'));
                        }
                    } else {
                        uploadProgress.style.display = 'none';
                        reject(new Error('Chyba p≈ôi nahr√°v√°n√≠ obr√°zku'));
                    }
                });
                
                xhr.addEventListener('error', () => {
                    uploadProgress.style.display = 'none';
                    reject(new Error('Chyba p≈ôipojen√≠ k serveru'));
                });
                
                xhr.addEventListener('abort', () => {
                    uploadProgress.style.display = 'none';
                    reject(new Error('Nahr√°v√°n√≠ zru≈°eno'));
                });
                
                xhr.open('POST', `${API_BASE}/upload/image`);
                xhr.send(formData);
            });
        }
        
        // Modal functions
        async function openAddModal() {
            editingProductId = null;
            document.getElementById('productId').value = '';
            document.getElementById('modalTitle').textContent = 'P≈ôidat produkt';
            currentProductGallery = [];
            displayProductGallery();
            document.querySelector('input[name="imageSource"][value="url"]').checked = true;
            toggleImageSource();
            
            // Otev≈ô√≠t modal nejd≈ô√≠v, aby byly selecty v DOM
            document.getElementById('productModal').classList.add('active');
            
            // Naƒç√≠st hodnoty atribut≈Ø z API a naplnit selecty
            await loadAttributeValues();
            
            // Reset formul√°≈ôe PO naplnƒõn√≠ select≈Ø (aby se nevymazaly)
            document.getElementById('productForm').reset();
            
            // Znovu naplnit selecty (reset je vymazal)
            populateAttributeSelects();
            
            // Vyƒçistit atributy
            document.getElementById('attributeDiameter').value = '';
            document.getElementById('attributeConnectionType').value = '';
            document.getElementById('attributeShape').value = '';
            document.getElementById('attributeMaterial').value = '';
        }
        
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
            currentProductGallery = [];
            const uploadProgress = document.getElementById('uploadProgress');
            if (uploadProgress) uploadProgress.style.display = 'none';
        }
        
        document.getElementById('addProductBtn')?.addEventListener('click', openAddModal);
        document.getElementById('modalClose')?.addEventListener('click', closeModal);
        document.getElementById('modalCancel')?.addEventListener('click', closeModal);
        
        // Product form submit
        document.getElementById('productForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const productId = document.getElementById('productId').value;
            
            // Z√≠skat v≈°echny za≈°krtnut√© kategorie sortimentu (m≈Ø≈æe jich b√Ωt v√≠ce)
            const sortimentCheckboxes = form.querySelectorAll('input[name="sortimentCategories"]:checked');
            const sortimentCategories = Array.from(sortimentCheckboxes).map(cb => cb.value);
            
            const formData = {
                name: form.name.value,
                category: form.category.value,
                price: parseFloat(form.price.value),
                image: currentProductGallery.length > 0 ? currentProductGallery[0].url : null, // Pro zpƒõtnou kompatibilitu
                description: form.description.value,
                availabilityStatus: form.availabilityStatus.value,
                sortimentCategories: sortimentCategories // Pole kategori√≠ sortimentu (m≈Ø≈æe jich b√Ωt v√≠ce)
            };
            
            console.log('Saving product with sortimentCategories:', sortimentCategories);
            
            // Sb√≠rat atributy - pouze pokud maj√≠ hodnotu
            const attributes = {};
            if (form.attributeDiameter?.value) {
                // Automaticky p≈ôidat "DN " p≈ôed ƒç√≠slo, pokud tam je≈°tƒõ nen√≠
                let diameterValue = form.attributeDiameter.value.trim();
                if (diameterValue && !diameterValue.toUpperCase().startsWith('DN')) {
                    diameterValue = 'DN ' + diameterValue;
                }
                attributes.diameter = { value: diameterValue, type: 'text' };
            }
            if (form.attributeConnectionType?.value) {
                attributes.connection_type = { value: form.attributeConnectionType.value, type: 'text' };
            }
            if (form.attributeShape?.value) {
                attributes.shape = { value: form.attributeShape.value, type: 'text' };
            }
            if (form.attributeMaterial?.value) {
                attributes.material = { value: form.attributeMaterial.value, type: 'text' };
            }
            
            // P≈ôidat atributy pouze pokud jsou nƒõjak√© vyplnƒõn√©
            if (Object.keys(attributes).length > 0) {
                formData.attributes = attributes;
            }
            
            try {
                const url = productId 
                    ? `${API_BASE}/products/${productId}`
                    : `${API_BASE}/products`;
                const method = productId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const savedProductId = productId || data.product.id;
                    
                    // Ulo≈æit obr√°zky do galerie
                    if (currentProductGallery.length > 0) {
                        // Odstranit star√© obr√°zky (pokud editujeme)
                        if (productId) {
                            const imagesResponse = await fetch(`${API_BASE}/products/${savedProductId}/images`);
                            const imagesData = await imagesResponse.json();
                            if (imagesData.success) {
                                for (const img of imagesData.images) {
                                    await fetch(`${API_BASE}/products/${savedProductId}/images/${img.id}`, {
                                        method: 'DELETE'
                                    });
                                }
                            }
                        }
                        
                        // P≈ôidat nov√© obr√°zky
                        for (let i = 0; i < currentProductGallery.length; i++) {
                            const img = currentProductGallery[i];
                            await fetch(`${API_BASE}/products/${savedProductId}/images`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    imageUrl: img.url,
                                    displayOrder: i
                                })
                            });
                        }
                    }
                    
                    showSuccess(productId ? 'Produkt √∫spƒõ≈°nƒõ aktualizov√°n' : 'Produkt √∫spƒõ≈°nƒõ p≈ôid√°n');
                    closeModal();
                    loadProducts();
                } else {
                    showError(data.error || 'Chyba p≈ôi ukl√°d√°n√≠ produktu');
                }
            } catch (error) {
                console.error('Chyba:', error);
                showError('Chyba p≈ôipojen√≠ k serveru');
            }
        });
        
        // Search with debounce
        let searchTimeout;
        document.getElementById('searchInput')?.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadProducts();
            }, 300);
        });
        
        // Filters
        document.getElementById('filterCategory')?.addEventListener('change', () => {
            loadProducts();
        });
        
        document.getElementById('filterStatus')?.addEventListener('change', () => {
            loadProducts();
        });
        
        // Clear filters
        document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStatus').value = '';
            loadProducts();
        });
        
        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function showSuccess(message) {
            // TODO: Implementovat toast notifikace
            alert(message);
        }
        
        function showError(message) {
            alert(message);
        }
        
        // Initialize
        loadCategories();
        loadProducts();
    </script>
</body>
</html>
